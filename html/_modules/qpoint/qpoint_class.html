

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>qpoint.qpoint_class &#8212; qpoint 1.9.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.9.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">qpoint 1.9.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../qpoint.html" accesskey="U">qpoint</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for qpoint.qpoint_class</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">itertools.izip</span> <span class="k">as</span> <span class="nn">zip</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">_libqpoint</span> <span class="k">as</span> <span class="n">lib</span>
<span class="kn">from</span> <span class="nn">._libqpoint</span> <span class="k">import</span> <span class="n">libqp</span> <span class="k">as</span> <span class="n">qp</span>
<span class="kn">from</span> <span class="nn">._libqpoint</span> <span class="k">import</span> <span class="n">check_input</span><span class="p">,</span> <span class="n">check_inputs</span><span class="p">,</span> <span class="n">check_output</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;QPoint&#39;</span><span class="p">,</span> <span class="s1">&#39;check_input&#39;</span><span class="p">,</span> <span class="s1">&#39;check_inputs&#39;</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="QPoint"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint">[docs]</a><span class="k">class</span> <span class="nc">QPoint</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a QPoint memory instance for keeping track of pointing</span>
<span class="sd">        corrections over time.</span>

<span class="sd">        Any keyword arguments are passed to QPoint.set to update memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initialize memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_memory</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">qp_init_memory</span><span class="p">()</span>

        <span class="c1"># collect all parameter functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">qp_funcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_funcs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_funcs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="c1"># set any requested parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="QPoint.print_memory"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.print_memory">[docs]</a>    <span class="k">def</span> <span class="nf">print_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print current memory state in C.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_print_memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Free memory before deleting the object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_free_memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set a single parameter to the given value.  See QPoint.set for a list</span>
<span class="sd">        of parameter names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_funcs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Unknown parameter </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_funcs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;check_set&#39;</span><span class="p">](</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_funcs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;set&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the value for a single parameter.  See QPoint.set for a list of</span>
<span class="sd">        parameter names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_funcs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Unknown parameter </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_funcs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;get&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_funcs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;check_get&#39;</span><span class="p">](</span><span class="n">val</span><span class="p">)</span>

<div class="viewcode-block" id="QPoint.set"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Available keywords are:</span>

<span class="sd">        * Correction rates:</span>
<span class="sd">          NB: these can be &#39;never&#39; (-999), &#39;once&#39; (-1), &#39;always&#39; (0) or seconds</span>
<span class="sd">        rate_daber     Rate at which the diurnal aberration correction is</span>
<span class="sd">                       applied (NB: this can only be applied always or never)</span>
<span class="sd">        rate_lonlat    Rate at which observer&#39;s lon and lat are updated</span>
<span class="sd">        rate_wobble    Rate at which the polar motion correction is updated</span>
<span class="sd">                       (NB: these are not estimated for dates beyond a year</span>
<span class="sd">                       from now)</span>
<span class="sd">        rate_dut1      Rate at which the ut1-utc correction is updated</span>
<span class="sd">                       (NB: this is not estimated for dates beyond a year from</span>
<span class="sd">                       now)</span>
<span class="sd">        rate_erot      Rate at which the earth&#39;s rotation angle is updated</span>
<span class="sd">        rate_npb       Rate at which the nutation/precession/frame-bias terms</span>
<span class="sd">                       are updated</span>
<span class="sd">        rate_aaber     Rate at which the annual aberration correction</span>
<span class="sd">                       (due to the earth&#39;s orbital velocity) is updated</span>
<span class="sd">        rate_ref       Rate at which the refaction correction is updated</span>
<span class="sd">                       (NB: this correction can also be updated manually -- see</span>
<span class="sd">                       refraction)</span>

<span class="sd">        * Options:</span>
<span class="sd">        accuracy       If &#39;low&#39;, use a truncated form (2000b) for the NPB</span>
<span class="sd">                       correction, which is much faster but less accurate.</span>
<span class="sd">                       If &#39;high&#39; (default), use the full 2006/2000a form.</span>
<span class="sd">        mean_aber      If True, apply the aberration correction as an average</span>
<span class="sd">                       for the entire field of view.  This is gives a 1-2</span>
<span class="sd">                       arcsec deviation at the edges of the SPIDER field of</span>
<span class="sd">                       view.</span>
<span class="sd">        fast_math      If True, use polynomial approximations for trig</span>
<span class="sd">                       functions</span>
<span class="sd">        polconv        Specify the &#39;cosmo&#39; or &#39;iau&#39; polarization convention</span>
<span class="sd">        pix_order      &#39;nest&#39; or &#39;ring&#39; for healpix pixel ordering</span>
<span class="sd">        interp_pix     If True, interpolate between pixels in scanning the</span>
<span class="sd">                       source map.</span>
<span class="sd">        fast_pix       If True, use vec2pix to get pixel number directly from</span>
<span class="sd">                       the quaternion instead of ang2pix from ra/dec.</span>
<span class="sd">        error_missing  If True, raise an error if reading/writing missing pixels.</span>
<span class="sd">        nan_missing    If True, fill samples from missing pixels with NaN.</span>
<span class="sd">                       Only used if error_missing is False.</span>
<span class="sd">        interp_missing If True and interp_pix is True, drop missing neighbors</span>
<span class="sd">                       and reweight remaining neighbors.  Overrides nan_missing.</span>
<span class="sd">        num_threads    Number of threads for openMP bore2map computation</span>

<span class="sd">        * Weather:</span>
<span class="sd">        temperature    temperature, Celcius</span>
<span class="sd">        pressure       pressure, mbar</span>
<span class="sd">        humidity       relative humidity, fraction</span>
<span class="sd">        frequency      observer frequency, GHz</span>

<span class="sd">        * Parameters:</span>
<span class="sd">        dut1           UT1 correction</span>
<span class="sd">        ref_delta      Refraction correction</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span></div>

<div class="viewcode-block" id="QPoint.get"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary of the requested state parameters.  If no</span>
<span class="sd">        parameters are supplied, then all are returned.  If a single parameter</span>
<span class="sd">        is supplied, then just that value is returned.  See QPoint.set for a</span>
<span class="sd">        list of parameter names.</span>

<span class="sd">        Can also select &#39;options&#39;, &#39;rates&#39;, &#39;weather&#39;, or &#39;params&#39; to return</span>
<span class="sd">        all of that subset of parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">state</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">arg</span><span class="p">]:</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">arg</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">state</span></div>

<div class="viewcode-block" id="QPoint.reset_rates"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.reset_rates">[docs]</a>    <span class="k">def</span> <span class="nf">reset_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset update counters for each state.  Useful to force an updated</span>
<span class="sd">        correction term at the beginning of each chunk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_reset_rates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">)</span></div>

<div class="viewcode-block" id="QPoint.refraction"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.refraction">[docs]</a>    <span class="k">def</span> <span class="nf">refraction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update refraction parameters</span>

<span class="sd">        Arguments (positional or keyword):</span>

<span class="sd">        q            observer orientation in horizon coordinates</span>
<span class="sd">        temperature  temperature, Celcius</span>
<span class="sd">        pressure     pressure, mbar</span>
<span class="sd">        humidity     humidity, fraction</span>
<span class="sd">        frequency    array frequency, GHz</span>
<span class="sd">        delta        the refraction correction itself, in degrees</span>

<span class="sd">        If el is given, then the refraction correction in degrees</span>
<span class="sd">        is calculated, stored and returned after updating any other given</span>
<span class="sd">        parameters. Otherwise, the correction is returned w/out recalculating.</span>

<span class="sd">        Alternatively, if a single numerical argument, or the &#39;delta&#39; keyword</span>
<span class="sd">        argument is given, then the correction is stored with this value</span>
<span class="sd">        instead of being recalculated.</span>

<span class="sd">        Numpy-vectorized for el argument.  Note that this is not</span>
<span class="sd">        an efficient vectorization, and only the last calculated value is</span>
<span class="sd">        stored for use in the coordinate conversion functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;ref_delta&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="k">if</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delta&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;ref_delta&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="n">arg_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="s1">&#39;weather&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">arg_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span>

        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="s1">&#39;weather&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">x3</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">qp</span><span class="o">.</span><span class="n">qp_update_ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
            <span class="n">fvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">func</span><span class="p">,[</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">fvec</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
                <span class="k">return</span> <span class="n">delta</span><span class="p">[()]</span>
            <span class="k">return</span> <span class="n">delta</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="s1">&#39;ref_delta&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QPoint.gmst"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.gmst">[docs]</a>    <span class="k">def</span> <span class="nf">gmst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return Greenwich mean sidereal time for given ctimes and longitudes.</span>
<span class="sd">        Vectorized.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        ctime      unix time in seconds UTC</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        Any keywords accepted by the QPoint.set function can also be passed</span>
<span class="sd">        here, and will be processed prior to calculation.</span>

<span class="sd">        Outputs:</span>

<span class="sd">        gmst       Greenwich mean sidereal time of the observer</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ctime</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;ctime&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ctime</span><span class="p">))</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">size</span>

        <span class="n">gmst</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;gmst&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ctime</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_gmstn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">gmst</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gmst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">gmst</span></div>

<div class="viewcode-block" id="QPoint.lmst"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.lmst">[docs]</a>    <span class="k">def</span> <span class="nf">lmst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return local mean sidereal time for given ctimes and longitudes.</span>
<span class="sd">        Vectorized.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        ctime      unix time in seconds UTC</span>
<span class="sd">        lon        observer longitude (degrees)</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        Any keywords accepted by the QPoint.set function can also be passed</span>
<span class="sd">        here, and will be processed prior to calculation.</span>

<span class="sd">        Outputs:</span>

<span class="sd">        lmst       local mean sidereal time of the observer</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ctime</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">check_inputs</span><span class="p">(</span><span class="n">ctime</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">size</span>

        <span class="n">lmst</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;lmst&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ctime</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_lmstn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lmst</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lmst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lmst</span></div>

<div class="viewcode-block" id="QPoint.dipole"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.dipole">[docs]</a>    <span class="k">def</span> <span class="nf">dipole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return dipole amplitude in the given equatorial direction.</span>
<span class="sd">        Vectorized.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        ctime      unix time in seconds UTC</span>
<span class="sd">        ra         right ascension on the sky</span>
<span class="sd">        dec        declination on the sky</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        Any keywords accepted by the QPoint.set function can also be passed</span>
<span class="sd">        here, and will be processed prior to calculation.</span>

<span class="sd">        Outputs:</span>

<span class="sd">        dipole     dipole amplitude in K</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ctime</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">check_inputs</span><span class="p">(</span><span class="n">ctime</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">size</span>

        <span class="n">dipole</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;dipole&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ctime</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_dipolen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">dipole</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dipole</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dipole</span></div>

<div class="viewcode-block" id="QPoint.bore2dipole"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.bore2dipole">[docs]</a>    <span class="k">def</span> <span class="nf">bore2dipole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate dipole timestream for given offset and boresight pointing.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        q_off      Detector offset quaternion for a single detector,</span>
<span class="sd">                   calculated using det_offset</span>
<span class="sd">        ctime      array of unix times in seconds UTC</span>
<span class="sd">        q_bore     Nx4 array of quaternions encoding the boresight orientation</span>
<span class="sd">                   on the sky (as output by azel2radec)</span>

<span class="sd">        Outputs:</span>

<span class="sd">        dipole     dipole amplitude in K</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">q_off</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;q_off&#39;</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,),</span> <span class="n">quat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ctime</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;ctime&#39;</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">size</span>
        <span class="n">q_bore</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;q_bore&#39;</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">quat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">dipole</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;dipole&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ctime</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_bore2dipole</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span> <span class="n">dipole</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dipole</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dipole</span></div>

<div class="viewcode-block" id="QPoint.det_offset"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.det_offset">[docs]</a>    <span class="k">def</span> <span class="nf">det_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_az</span><span class="p">,</span> <span class="n">delta_el</span><span class="p">,</span> <span class="n">delta_psi</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return quaternion corresponding to the requested detector offset.</span>
<span class="sd">        Vectorized.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        delta_az   azimuthal offset of the detector (degrees)</span>
<span class="sd">        delta_el   elevation offset of the detector (degrees)</span>
<span class="sd">        delta_psi  polarization offset of the detector (degrees)</span>

<span class="sd">        Outputs:</span>

<span class="sd">        q          detector offset quaternion for each detector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">delta_az</span><span class="p">,</span> <span class="n">delta_el</span><span class="p">,</span> <span class="n">delta_psi</span> <span class="o">=</span> \
            <span class="n">check_inputs</span><span class="p">(</span><span class="n">delta_az</span><span class="p">,</span> <span class="n">delta_el</span><span class="p">,</span> <span class="n">delta_psi</span><span class="p">)</span>
        <span class="n">ndet</span> <span class="o">=</span> <span class="n">delta_az</span><span class="o">.</span><span class="n">size</span>

        <span class="n">quat</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;quat&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ndet</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_det_offsetn</span><span class="p">(</span><span class="n">delta_az</span><span class="p">,</span> <span class="n">delta_el</span><span class="p">,</span> <span class="n">delta_psi</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">ndet</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ndet</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">quat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">quat</span></div>

<div class="viewcode-block" id="QPoint.bore_offset"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.bore_offset">[docs]</a>    <span class="k">def</span> <span class="nf">bore_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span> <span class="n">ang1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ang2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ang3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">post</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a fixed or variable offset to the boresight quaternion.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        q_bore    boresight pointing quaternion</span>
<span class="sd">        ang1      azimuthal or ra offset (degrees), scalar or array</span>
<span class="sd">        ang2      elevation or dec offset (degrees), scalar or array</span>
<span class="sd">        ang3      position angle offset (degrees), scalar or array</span>
<span class="sd">        post      If False, apply offset as an az/el/pa pre-rotation</span>
<span class="sd">                  If True, apply offset as an ra/dec/pa post-rotation</span>
<span class="sd">        inplace   If True, apply the rotation in-place in memory.</span>

<span class="sd">        Outputs:</span>

<span class="sd">        q_bore    Offset boresight quaternion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q_bore</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;q_bore&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">q_bore</span><span class="p">),</span> <span class="n">quat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">q_bore</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ang1</span><span class="p">,</span> <span class="n">ang2</span><span class="p">,</span> <span class="n">ang3</span> <span class="o">=</span> \
            <span class="n">check_inputs</span><span class="p">(</span><span class="n">ang1</span><span class="p">,</span> <span class="n">ang2</span><span class="p">,</span> <span class="n">ang3</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,))</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_bore_offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span> <span class="n">ang1</span><span class="p">,</span> <span class="n">ang2</span><span class="p">,</span> <span class="n">ang3</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">post</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">q_bore</span></div>

<div class="viewcode-block" id="QPoint.hwp_quat"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.hwp_quat">[docs]</a>    <span class="k">def</span> <span class="nf">hwp_quat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return quaternion corresponding to rotation by 2*theta,</span>
<span class="sd">        where theta is the physical waveplate angle.</span>
<span class="sd">        Vectorized.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        theta      hwp physical angle (degrees)</span>

<span class="sd">        Outputs:</span>

<span class="sd">        q          quaternion for each hwp angle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">size</span>

        <span class="n">quat</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;quat&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_hwp_quatn</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">quat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">quat</span></div>

<div class="viewcode-block" id="QPoint.azel2bore"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.azel2bore">[docs]</a>    <span class="k">def</span> <span class="nf">azel2bore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the quaternion for the boresight orientation on the sky given</span>
<span class="sd">        the attitude (az/el/pitch/roll), location on the earth (lon/lat) and</span>
<span class="sd">        ctime. Input vectors must be numpy-array-like and of the same shape.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        az         boresight azimuth (degrees)</span>
<span class="sd">        el         boresight elevation (degrees)</span>
<span class="sd">        pitch      boresight pitch (degrees); can be None</span>
<span class="sd">        roll       boresight pitch (degrees); can be None</span>
<span class="sd">        lon        observer longitude (degrees)</span>
<span class="sd">        lat        observer latitude (degrees)</span>
<span class="sd">        ctime      unix time in seconds UTC</span>
<span class="sd">        q          output quaternion array initialized by user</span>

<span class="sd">        Keywork arguments:</span>

<span class="sd">        Any keywords accepted by the QPoint.set function can also be passed</span>
<span class="sd">        here, and will be processed prior to calculation.</span>

<span class="sd">        Output:</span>

<span class="sd">        q          Nx4 numpy array of quaternions for each supplied timestamp.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ctime</span> <span class="o">=</span> \
            <span class="n">check_inputs</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># identity quaternion</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">qp</span><span class="o">.</span><span class="n">qp_azel2bore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span>
                        <span class="n">ctime</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">q</span></div>

<div class="viewcode-block" id="QPoint.bore2radec"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.bore2radec">[docs]</a>    <span class="k">def</span> <span class="nf">bore2radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span> <span class="n">q_hwp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sindec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">return_pa</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">sin2psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cos2psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the orientation on the sky for a detector offset from the</span>
<span class="sd">        boresight.  Detector offsets are defined assuming the boresight is</span>
<span class="sd">        pointed toward the horizon, and that the boresight polarization axis is</span>
<span class="sd">        along the vertical.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        q_off      Detector offset quaternion for a single detector,</span>
<span class="sd">                   calculated using det_offset</span>
<span class="sd">        ctime      array of unix times in seconds UTC</span>
<span class="sd">        q_bore     Nx4 array of quaternions encoding the boresight orientation</span>
<span class="sd">                   on the sky (as output by azel2radec)</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        q_hwp      HWP angle quaternions calculated using hwp_quat</span>
<span class="sd">                   must be same shape as q_bore</span>
<span class="sd">        sindec     If True, return sin(dec) instead of dec in degrees</span>
<span class="sd">                   (default False)</span>
<span class="sd">        return_pa  If True, return pa instead of sin2psi / cos2psi</span>

<span class="sd">        Any keywords accepted by the QPoint.set function can also be passed</span>
<span class="sd">        here, and will be processed prior to calculation.</span>

<span class="sd">        Outputs:</span>

<span class="sd">        ra         detector right ascension (degrees)</span>
<span class="sd">        dec/sindec detector declination (degrees) or sin(dec)</span>
<span class="sd">        sin2psi    detector polarization orientation</span>
<span class="sd">        cos2psi    detector polarization orientation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">q_off</span>  <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;q_off&#39;</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">quat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">q_bore</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;q_bore&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">q_bore</span><span class="p">),</span> <span class="n">quat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean_aber&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ctime required if mean_aber is False&#39;</span><span class="p">)</span>
            <span class="n">ctime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">q_bore</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">q_bore</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">ctime</span>  <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;ctime&#39;</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">ctime</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="o">**</span><span class="n">pars</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="o">**</span><span class="n">pars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_pa</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sindec</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use sindec with return_pa=True&#39;</span><span class="p">)</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;pa&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="o">**</span><span class="n">pars</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sin2psi</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;sin2psi&#39;</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="o">**</span><span class="n">pars</span><span class="p">)</span>
            <span class="n">cos2psi</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;cos2psi&#39;</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="o">**</span><span class="n">pars</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">q_hwp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_pa</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_bore2radecpa</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span>
                                   <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sindec</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_bore2rasindec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span>
                                    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_bore2radec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span>
                                 <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q_hwp</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;q_hwp&#39;</span><span class="p">,</span> <span class="n">q_hwp</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">q_bore</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_pa</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_bore2radecpa_hwp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span>
                                       <span class="n">q_hwp</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sindec</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_bore2rasindec_hwp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span>
                                        <span class="n">q_hwp</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_bore2radec_hwp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span>
                                     <span class="n">q_hwp</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_pa</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sin2psi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cos2psi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span></div>

<div class="viewcode-block" id="QPoint.azel2radec"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.azel2radec">[docs]</a>    <span class="k">def</span> <span class="nf">azel2radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_az</span><span class="p">,</span> <span class="n">delta_el</span><span class="p">,</span> <span class="n">delta_psi</span><span class="p">,</span>
                   <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span>
                   <span class="n">hwp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sindec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">sin2psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cos2psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the orientation on the sky for a detector offset from</span>
<span class="sd">        boresight, given the boresight attitude (az/el/pitch/roll), location on</span>
<span class="sd">        the earth (lon/lat) and UTC time.  Input vectors must be</span>
<span class="sd">        numpy-array-like and of the same shape. Detector offsets are defined</span>
<span class="sd">        assuming the boresight is pointed toward the horizon, and that the</span>
<span class="sd">        boresight polarization axis is along the horizontal.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        delta_az   azimuthal offset of the detector (degrees)</span>
<span class="sd">        delta_el   elevation offset of the detector (degrees)</span>
<span class="sd">        delta_psi  polarization offset of the detector (degrees)</span>
<span class="sd">        az         boresight azimuth (degrees)</span>
<span class="sd">        el         boresight elevation (degrees)</span>
<span class="sd">        pitch      boresight pitch (degrees); can be None</span>
<span class="sd">        roll       boresight roll (degrees); can be None</span>
<span class="sd">        lon        observer longitude (degrees)</span>
<span class="sd">        lat        observer latitude (degrees)</span>
<span class="sd">        ctime      unix time in seconds UTC</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        hwp        HWP angles (degrees)</span>
<span class="sd">        sindec     If True, return sin(dec) instead of dec in degrees</span>
<span class="sd">                   (default False)</span>

<span class="sd">        Any keywords accepted by the QPoint.set function can also be passed</span>
<span class="sd">        here, and will be processed prior to calculation.</span>

<span class="sd">        Outputs:</span>

<span class="sd">        ra         detector right ascension (degrees)</span>
<span class="sd">        dec/sindec detector declination (degrees)</span>
<span class="sd">        sin2psi    detector polarization orientation</span>
<span class="sd">        cos2psi    detector polarization orientation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ctime</span> <span class="o">=</span> \
            <span class="n">check_inputs</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>

        <span class="n">ra</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">az</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">az</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="n">sin2psi</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;sin2psi&#39;</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">az</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="n">cos2psi</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;cos2psi&#39;</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">az</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">hwp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sindec</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_azel2rasindec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">delta_az</span><span class="p">,</span> <span class="n">delta_el</span><span class="p">,</span> <span class="n">delta_psi</span><span class="p">,</span>
                                    <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span>
                                    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_azel2radec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">delta_az</span><span class="p">,</span> <span class="n">delta_el</span><span class="p">,</span> <span class="n">delta_psi</span><span class="p">,</span>
                                 <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span>
                                 <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hwp</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;hwp&#39;</span><span class="p">,</span> <span class="n">hwp</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">az</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sindec</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_azel2rasindec_hwp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">delta_az</span><span class="p">,</span> <span class="n">delta_el</span><span class="p">,</span> <span class="n">delta_psi</span><span class="p">,</span>
                                        <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">hwp</span><span class="p">,</span>
                                        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_azel2radec_hwp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">delta_az</span><span class="p">,</span> <span class="n">delta_el</span><span class="p">,</span> <span class="n">delta_psi</span><span class="p">,</span>
                                     <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">hwp</span><span class="p">,</span>
                                     <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span></div>

<div class="viewcode-block" id="QPoint.radecpa2quat"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.radecpa2quat">[docs]</a>    <span class="k">def</span> <span class="nf">radecpa2quat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate quaternion for input ra/dec/pa.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">check_inputs</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ra</span><span class="o">.</span><span class="n">size</span>
        <span class="n">quat</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;quat&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_radecpa2quatn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">quat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">quat</span></div>

<div class="viewcode-block" id="QPoint.quat2radecpa"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.quat2radecpa">[docs]</a>    <span class="k">def</span> <span class="nf">quat2radecpa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate ra/dec/pa for input quaternion(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">quat</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;quat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">quat</span><span class="p">),</span> <span class="n">quat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">quat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;pa&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">qp</span><span class="o">.</span><span class="n">qp_quat2radecpan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span></div>

<div class="viewcode-block" id="QPoint.radec2pix"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.radec2pix">[docs]</a>    <span class="k">def</span> <span class="nf">radec2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">nside</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate healpix pixel number for given ra/dec and nside</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">check_inputs</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ra</span><span class="o">.</span><span class="n">size</span>

        <span class="n">pix</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;pix&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_radec2pixn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">nside</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pix</span></div>

<div class="viewcode-block" id="QPoint.rotate_quat"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.rotate_quat">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_quat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate a quaternion from one coordinate system to another.</span>
<span class="sd">        Supported coordinates:</span>

<span class="sd">        C: celestial (equatorial) coordinates</span>
<span class="sd">        G: galactic coordinates</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        quat : array_like</span>
<span class="sd">            array of quaternions, of shape (n, 4)</span>
<span class="sd">        coord : list, optional</span>
<span class="sd">            2-element list of input and output coordinates</span>
<span class="sd">        inplace : bool, optional</span>
<span class="sd">            If True, apply the rotation in-place on the input quaternion.</span>
<span class="sd">            Otherwise, return a copy of the input array.  Default: True.</span>

<span class="sd">        Remaining keyword arguments are passed to the `QMap.set` method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        quat : array_like</span>
<span class="sd">            rotated quaternion array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">quat</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;quat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">quat</span><span class="p">),</span> <span class="n">quat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">quat</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">4</span>

        <span class="k">if</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span>
            <span class="n">qp</span><span class="o">.</span><span class="n">qp_radec2gal_quatn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;G&#39;</span> <span class="ow">and</span> <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
            <span class="n">qp</span><span class="o">.</span><span class="n">qp_gal2radec_quatn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unsupported coord </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coord</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">quat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span></div>

<div class="viewcode-block" id="QPoint.rotate_coord"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.rotate_coord">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sin2psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cos2psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">coord</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate coordinates from one coordinate system to another.</span>
<span class="sd">        Supported coordinates:</span>

<span class="sd">        C: celestial (equatorial) coordinates</span>
<span class="sd">        G: galactic coordinates</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        ra, dec, pa : array_like</span>
<span class="sd">          -- or --</span>
<span class="sd">        ra, dec, sin2psi, cos2psi : array_like</span>
<span class="sd">            arrays of coordinates, of shape (n,)</span>
<span class="sd">            If none of pa, sin2psi or cos2psi are supplied,</span>
<span class="sd">            pa = 0 is assumed.</span>
<span class="sd">        coord : list, optional</span>
<span class="sd">            2-element list of input and output coordinates.</span>
<span class="sd">            Supported systems: C, G.</span>
<span class="sd">        inplace : bool, optional</span>
<span class="sd">            If True, apply the rotation in-place on the input quaternion.</span>
<span class="sd">            Otherwise, return a copy of the input array.  Default: True.</span>

<span class="sd">        Remaining keyword arguments are passed to the `QMap.set` method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ra, dec, pa : array_like</span>
<span class="sd">          -- or --</span>
<span class="sd">        ra, dec, sin2psi, cos2psi : array_like</span>
<span class="sd">            rotated coordinate arrays, same form as input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">do_pa</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">pa</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sin2psi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cos2psi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">sin2psi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cos2psi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;both sin2psi and cos2psi arguments required&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">do_pa</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sin2psi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cos2psi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;ambiguous pol arguments, supply either pa &#39;</span>
                               <span class="s1">&#39;or sin2psi/cos2psi only&#39;</span><span class="p">)</span>

        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span> <span class="o">=</span> \
            <span class="n">check_inputs</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ra</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_pa</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_radecpa2galn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_radec2galn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;G&#39;</span> <span class="ow">and</span> <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_pa</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_gal2radecpan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qp</span><span class="o">.</span><span class="n">qp_gal2radecn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_pa</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sin2psi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cos2psi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">do_pa</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span>
        <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span></div>

<div class="viewcode-block" id="QPoint.radec2gal"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.radec2gal">[docs]</a>    <span class="k">def</span> <span class="nf">radec2gal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sin2psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cos2psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate celestial coordinates to galactic coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate_coord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span>
                                 <span class="n">coord</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;G&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="QPoint.gal2radec"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.gal2radec">[docs]</a>    <span class="k">def</span> <span class="nf">gal2radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sin2psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cos2psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate celestial coordinates to galactic coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate_coord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span>
                                 <span class="n">coord</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="QPoint.rotate_map"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.rotate_map">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_in</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;G&#39;</span><span class="p">],</span> <span class="n">map_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">interp_pix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate a polarized npix-x-3 map from one coordinate system to another.</span>
<span class="sd">        Supported coordinates:</span>

<span class="sd">        C = celestial (J2000)</span>
<span class="sd">        G = galactic</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;This code is buggy, use at your own risk&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

        <span class="n">interp_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interp_pix&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">interp_pix</span><span class="o">=</span><span class="n">interp_pix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">.qmap_class</span> <span class="k">import</span> <span class="n">check_map</span>
        <span class="n">map_in</span><span class="p">,</span> <span class="n">nside</span> <span class="o">=</span> <span class="n">check_map</span><span class="p">(</span><span class="n">map_in</span><span class="p">)</span>
        <span class="n">map_out</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span>
            <span class="s1">&#39;map_out&#39;</span><span class="p">,</span> <span class="n">map_out</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">map_in</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">map_in</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">coord_in</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">coord_out</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unable to parse coord&#39;</span><span class="p">)</span>

        <span class="n">map_in_p</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pointer_2d</span><span class="p">(</span><span class="n">map_in</span><span class="p">)</span>
        <span class="n">map_out_p</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pointer_2d</span><span class="p">(</span><span class="n">map_out</span><span class="p">)</span>

        <span class="n">qp</span><span class="o">.</span><span class="n">qp_rotate_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">nside</span><span class="p">,</span> <span class="n">map_in_p</span><span class="p">,</span> <span class="n">coord_in</span><span class="p">,</span>
                         <span class="n">map_out_p</span><span class="p">,</span> <span class="n">coord_out</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">interp_pix</span><span class="o">=</span><span class="n">interp_orig</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">map_out</span></div>

<div class="viewcode-block" id="QPoint.quat2pix"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.quat2pix">[docs]</a>    <span class="k">def</span> <span class="nf">quat2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">nside</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate healpix pixel number and polarization angle given</span>
<span class="sd">        quaternion and nside</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">quat</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;quat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">quat</span><span class="p">),</span> <span class="n">quat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">quat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,)</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;pix&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">sin2psi</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;sin2psi&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">cos2psi</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;cos2psi&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">qp</span><span class="o">.</span><span class="n">qp_quat2pixn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">nside</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pix</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span> <span class="o">=</span> <span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sin2psi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cos2psi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pix</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span>
        <span class="k">return</span> <span class="n">pix</span></div>

<div class="viewcode-block" id="QPoint.bore2pix"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.bore2pix">[docs]</a>    <span class="k">def</span> <span class="nf">bore2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span> <span class="n">q_hwp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nside</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the orientation on the sky for a detector offset from the</span>
<span class="sd">        boresight.  Detector offsets are defined assuming the boresight is</span>
<span class="sd">        pointed toward the horizon, and that the boresight polarization axis is</span>
<span class="sd">        along the vertical.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        q_off      Detector offset quaternion for a single detector,</span>
<span class="sd">                   calculated using det_offset</span>
<span class="sd">        ctime      array of unix times in seconds UTC</span>
<span class="sd">        q_bore     Nx4 array of quaternions encoding the boresight orientation</span>
<span class="sd">                   on the sky (as output by azel2radec)</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        q_hwp      HWP angle quaternions calculated using hwp_quat</span>
<span class="sd">                   must be same shape as q_bore</span>
<span class="sd">        nside      map dimension</span>
<span class="sd">        pol        if False, return only the pixel timestream</span>

<span class="sd">        Any keywords accepted by the QPoint.set function can also be passed</span>
<span class="sd">        here, and will be processed prior to calculation.</span>

<span class="sd">        Outputs:</span>

<span class="sd">        pix        detector pixel number</span>
<span class="sd">        sin2psi    detector polarization orientation (if pol is True)</span>
<span class="sd">        cos2psi    detector polarization orientation (if pol is True)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">q_off</span>  <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;q_off&#39;</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">quat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">q_bore</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;q_bore&#39;</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span> <span class="n">quat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean_aber&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ctime required if mean_aber is False&#39;</span><span class="p">)</span>
            <span class="n">ctime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">q_bore</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">q_bore</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">ctime</span>  <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;ctime&#39;</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>
        <span class="n">pix</span>  <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;pix&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ctime</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">sin2psi</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;sin2psi&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ctime</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">cos2psi</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;cos2psi&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">ctime</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">q_hwp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qp</span><span class="o">.</span><span class="n">qp_bore2pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span>
                           <span class="n">nside</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q_hwp</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">(</span><span class="s1">&#39;q_hwp&#39;</span><span class="p">,</span> <span class="n">q_hwp</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">q_bore</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">qp</span><span class="o">.</span><span class="n">qp_bore2pix_hwp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">q_off</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">,</span>
                               <span class="n">q_hwp</span><span class="p">,</span> <span class="n">nside</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pix</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span>
        <span class="k">return</span> <span class="n">pix</span></div>

<div class="viewcode-block" id="QPoint.get_interp_val"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.get_interp_val">[docs]</a>    <span class="k">def</span> <span class="nf">get_interp_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_in</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">nest</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolate map pixels to these coordinates.  Uses a C implementation</span>
<span class="sd">        of the bilinear interpolation method `get_interpol()` as implemented</span>
<span class="sd">        in the equivalent healpix_cxx / healpy function.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        map_in : array_like</span>
<span class="sd">            A single healpix map or list of maps which to interpolate from.</span>
<span class="sd">        ra, dec: array_like</span>
<span class="sd">            Timestreams of coordinates to interpolate to, in degrees,</span>
<span class="sd">            of shape (nsample,)</span>
<span class="sd">        nest: bool, optional</span>
<span class="sd">            If True, input map is in the nested pixel ordering scheme.</span>
<span class="sd">            Otherwise, ring ordering is assumed.</span>
<span class="sd">            Default: False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        values : array_like</span>
<span class="sd">            Array of interpolated map values, of shape (nmap, nsample).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pix_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pix_order&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nest</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pix_order</span><span class="o">=</span><span class="s1">&#39;nest&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pix_order</span><span class="o">=</span><span class="s1">&#39;ring&#39;</span><span class="p">)</span>

        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">check_inputs</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ra</span><span class="o">.</span><span class="n">size</span>

        <span class="kn">from</span> <span class="nn">.qmap_class</span> <span class="k">import</span> <span class="n">check_map</span>
        <span class="n">map_in</span><span class="p">,</span> <span class="n">nside</span> <span class="o">=</span> <span class="n">check_map</span><span class="p">(</span><span class="n">map_in</span><span class="p">)</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">map_in</span><span class="p">),</span> <span class="n">n</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">map_in</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="n">qp</span><span class="o">.</span><span class="n">qp_get_interp_valn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">nside</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pix_order</span><span class="o">=</span><span class="n">pix_order</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">[()]</span>
        <span class="k">return</span> <span class="n">v</span></div>

<div class="viewcode-block" id="QPoint.load_bulletin_a"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.load_bulletin_a">[docs]</a>    <span class="k">def</span> <span class="nf">load_bulletin_a</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span><span class="s1">&#39;dut1&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load IERS Bulletin A from file and store in memory.  The file must be</span>
<span class="sd">        readable using numpy.loadtxt with unpack=True, and is assumed to be sorted</span>
<span class="sd">        by mjd.</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        columns    list of columns as they appear in the file.</span>
<span class="sd">                   A KeyError is raise if the list does not contain</span>
<span class="sd">                   each of [&#39;mjd&#39;, &#39;dut1&#39;, &#39;x&#39;, &#39;y&#39;]</span>

<span class="sd">        Any other keyword arguments are passed to the numpy.loadtxt function</span>

<span class="sd">        Output:</span>

<span class="sd">        mjd, dut1, x, y</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">req_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span><span class="s1">&#39;dut1&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">req_columns</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s1">&#39;Missing columns </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">req_columns</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">columns</span><span class="p">))))</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;unpack&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">mjd</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dut1</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">req_columns</span><span class="p">)</span>
        <span class="n">mjd_min</span><span class="p">,</span> <span class="n">mjd_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mjd</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">mjd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">qp</span><span class="o">.</span><span class="n">qp_set_iers_bulletin_a</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">mjd_min</span><span class="p">,</span> <span class="n">mjd_max</span><span class="p">,</span> <span class="n">dut1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Error loading Bulletin A data from file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">mjd</span><span class="p">,</span> <span class="n">dut1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>

<div class="viewcode-block" id="QPoint.get_bulletin_a"><a class="viewcode-back" href="../../qpoint.html#qpoint.qpoint_class.QPoint.get_bulletin_a">[docs]</a>    <span class="k">def</span> <span class="nf">get_bulletin_a</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mjd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return dut1/x/y for given mjd. Numpy-vectorized.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lib</span><span class="o">.</span><span class="n">qp_get_bulletin_a</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">fvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">fvec</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">[()]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">qpoint 1.9.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../qpoint.html" >qpoint</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Alexandra Rahlin.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.2.
    </div>
  </body>
</html>